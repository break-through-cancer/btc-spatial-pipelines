nextflow_pipeline {

    name "Test Workflow main.nf"
    script "main.nf"

    test("Just check samplesheet and read visium to adata") {

        tag "samplesheet"

        when {
            params {
                input = "../../../tests/samplesheet-test.csv"
                outdir = "tests/results"
                max_memory = "8.GB"
                max_cpus = 4
            }
        }

        then {
            assert workflow.success
        }

    }

        test("Fail on empty samplesheet") {

        tag "samplesheet"

        when {
            params {
                input = "../../../tests/samplesheet-empty-test.csv"
                outdir = "tests/results"
                max_memory = "8.GB"
                max_cpus = 4
            }
        }

        then {
            assert workflow.success == false
        }

    }

    test("RCTD on Visium SD with reference as URL") {

        tag "visiumsd"

        when {
            params {
                input = "../../../tests/sdvisium-test.csv"
                outdir = "tests/results"
                max_memory = "8.GB"
                max_cpus = 4
                reference_scrna = "https://datasets.cellxgene.cziscience.com/6c29f947-d85b-483e-b346-b163277dae5e.h5ad"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("RCTD on Visium HD with reference as URL") {

        tag "visiumhd"

        when {
            params {
                input = "../../../tests/hdvisium-test.csv"
                outdir = "tests/results"
                max_memory = "8.GB"
                max_cpus = 4
                reference_scrna = "https://datasets.cellxgene.cziscience.com/6c29f947-d85b-483e-b346-b163277dae5e.h5ad"
                hd = "square_016um"
            }
        }

        then {
            assert workflow.success
        }

    }

}
